<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Handelsspiel – Elandor</title>
  <style>
    body {
      background: #f4f1e5;
      font-family: 'Georgia', serif;
      margin: 0;
    }
    header {
      background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/f/fd/Parchment_texture.jpg/800px-Parchment_texture.jpg');
      background-size: cover;
      padding: 10px;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      background: #6b4f2d;
    }
    nav button {
      background: #8b5e3c;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      border-radius: 8px;
    }
    nav button:hover {
      background: #a97144;
    }
    #karte {
      /* Breite auf 100% des Containers (oder einer anderen gewünschten Breite) */
      width: 100%;
      /* Höhe passt sich automatisch an, um das Seitenverhältnis der viewBox beizubehalten */
      height: auto;
      /* Entferne den blauen Hintergrund, da das Bild jetzt die gesamte Fläche abdecken sollte */
      /* background: #cceeff; */
      display: block; /* Stellt sicher, dass keine unerwünschten Ränder entstehen */
    }
    #inhalt {
      padding: 20px;
      background: #fffdf7;
      border: 1px solid #ddd;
      margin: 10px;
      border-radius: 8px;
    }
    .stadt-button {
      fill: #3366cc; /* Standardfarbe für Städte */
      cursor: pointer;
      transition: fill 0.2s, r 0.2s; /* Sanfter Übergang für Hover/Auswahl */
    }
    .stadt-button:hover {
      fill: #5588ee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left; /* Text linksbündig für bessere Lesbarkeit */
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      background: #4CAF50; /* Grün für Aktionen */
      color: white;
      border: none;
      padding: 5px 10px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 2px 2px;
      cursor: pointer;
      border-radius: 4px; /* Angepasst auf 4px */
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    input[type="number"] {
        width: 60px;
        padding: 5px;
        margin-right: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* NEUE STYLES FÜR SCHIFFSMENÜ */
    .schiff-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsives Raster */
        gap: 20px;
        margin-top: 20px;
    }
    .schiff-karte {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Inhalte oben/unten ausrichten */
    }
    .schiff-karte h3 {
        margin-top: 0;
        color: #333;
    }
    .schiff-info p {
        margin: 5px 0;
        font-size: 0.9em;
    }
    .schiff-aktionen {
        margin-top: 15px;
        text-align: center;
    }
    .kaufen-button {
        background: #007bff; /* Blau für Kauf-Buttons */
        color: white;
        border: none;
        padding: 10px 20px; /* Größerer Padding */
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
        width: 100%; /* Volle Breite innerhalb der Karte */
        box-sizing: border-box; /* Padding und Border innerhalb der Breite */
    }
    .kaufen-button:hover {
        background: #0056b3;
    }
    .kaufen-button:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
  </style>
</head>
<body>

<header>
  <h1>Handelsspiel – Elandor</h1>
</header>

<nav>
  <button onclick="zeigeMenue('uebersicht')">Übersicht</button>
  <button onclick="zeigeMenue('handel')">Handel</button>
  <button onclick="zeigeMenue('gebaeude')">Gebäude</button>
  <button onclick="zeigeMenue('schiffe')">Schiffe</button>
</nav>

<div id="spielerStatus" style="padding: 10px; background: #e0d8c1; border: 1px solid #c0b8a1; margin: 10px; border-radius: 8px;">
  <h3>Dein Status:</h3>
  <p>Gold: <span id="goldAnzeige"></span></p>
  <p>Level: <span id="levelAnzeige"></span> (<span id="xpAnzeige"></span> XP)</p>
  <p>Ruf: <span id="rufAnzeige"></span> (<span id="rufRangAnzeige"></span>)</p>
  <p>Aktuelle Stadt: <span id="aktuelleStadtAnzeige">Keine</span></p>
  <p>Ladekapazität: <span id="ladekapazitaetAnzeige"></span></p>
</div>

<svg id="karte" viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg">
  <image href="https://raw.githubusercontent.com/ebrius0/Handelsspiel/main/file_0000000020d861fb8c92bec003f416bd%20(1).png" x="0" y="0" height="600" width="1000" preserveAspectRatio="xMidYMid slice"/>
</svg>

<div id="inhalt">
  <p>Lade Spiel...</p>
</div>

<script>
  // --- SPIELERDATEN ---
  const SPIELER_DATEN = {
    gold: 5000, // Startkapital erhöht für besseres Testen
    level: 1,
    xp: 0,
    ruf: 0, // Neuer Rufwert, startet bei 0
    aktuelleStadt: null,
    schiffeBesitz: [], // Hier speichern wir Schiffe, die der Spieler besitzt
    inventar: {}, // z.B. { 'Getreide': 10, 'Holz': 5 } - gesamt über alle Schiffe
    gebaeude: {} // z.b. { 'Elandor': { 'Lagerhaus': 1 } }
  };

  // --- RUF-RANG-DEFINITIONEN ---
  const RUF_RANG_DEFINITIONEN = {
    '-5': { name: 'Geächteter Händler', beschreibung: 'Ein Händler, der das Vertrauen aller verloren hat. Gerüchte über seine unehrlichen Machenschaften eilen ihm voraus.' },
    '-4': { name: 'Wucherer Händler', beschreibung: 'Seine Gier kennt keine Grenzen. Städte meiden ihn, und man munkelt, er würde seine Kunden gnadenlos ausnehmen.' },
    '-3': { name: 'Zwielichtiger Händler', beschreibung: 'Man traut ihm nicht über den Weg. Seine Geschäfte sind oft undurchsichtig und grenzen an Betrug.' },
    '-2': { name: 'Raffgieriger Händler', beschreibung: 'Er handelt nur zu seinem eigenen Vorteil und kümmert sich nicht um die Bedürfnisse der Gemeinschaft.' },
    '-1': { name: 'Schmarotzer Händler', beschreibung: 'Man weiß nie, woran man bei ihm ist. Kleine Vergehen und das Ausnutzen von Notlagen sind ihm nicht fremd.' },
    '0': { name: 'Unbeachteter Händler', beschreibung: 'Ein durchschnittlicher Händler, der seine Geschäfte macht, ohne groß aufzufallen.' },
    '+1': { name: 'Redlicher Händler', beschreibung: 'Er ist bekannt für seine harte Arbeit und ehrlichen Handel. Ein solider Partner.' },
    '+2': { name: 'Angesehener Händler', beschreibung: 'Sein Geschäft blüht, und er hat sich einen guten Namen gemacht. Man schätzt seine Anwesenheit in den Städten.' },
    '+3': { name: 'Wohltäter Händler', beschreibung: 'Er trägt aktiv zum Wohlstand der Städte bei und hilft in Notlagen. Sein Ruf eilt ihm voraus.' },
    '+4': { name: 'Edler Händler', beschreibung: 'Ein wahrer Meister des Handels, dessen Integrität und Reichtum sprichwörtlich sind. Seine Ankunft wird gefeiert.' },
    '+5': { name: 'Königlicher Händler', beschreibung: 'Der Gipfel des Ansehens. Seine Handelsimperium ist legendär, und er genießt das Vertrauen und die Gunst der höchsten Adligen.' }
  };

  // --- STÄDTEDATEN ---
  // Koordinaten wurden für eine generische Fantasy-Karte angepasst.
  // Du musst diese eventuell noch feinjustieren, damit sie perfekt zu DEINER spezifischen Karte passen!
  // Produktionsfaktoren: Niedrigerer Wert = Stadt produziert die Ware effektiv (günstigerer Verkauf für Spieler).
  // Ein Faktor von 1.0 bedeutet Standardpreis. Ein Faktor > 1.0 bedeutet die Stadt ist kein "Produzent" dieser Ware.
  // HINWEIS: Die Lagerbestände hier sind die INITIALEN Bestände. Sie werden im Spiel dynamisch angepasst.
  const STAEDTE = {
    // Region: Nördliche Küstenregion / Fruchtbares Land
    'Aethelgard': { x: 150, y: 120, einwohner: 1200, versorgung: 'Gut',
      gueter: {
        'Getreide': { basisPreis: 10, lager: 80, produktionsFaktor: 0.8 }, // Hauptproduzent Getreide
        'Fisch': { basisPreis: 12, lager: 60, produktionsFaktor: 0.9 },
        'Wolle': { basisPreis: 15, lager: 40, produktionsFaktor: 0.95 }
      }
    },
    'Port Valerius': { x: 280, y: 80, einwohner: 1500, versorgung: 'Sehr Gut',
      gueter: {
        'Holz': { basisPreis: 15, lager: 50, produktionsFaktor: 0.9 },
        'Tuch': { basisPreis: 25, lager: 30, produktionsFaktor: 1.0 }, // Kann Tuch herstellen, aber nicht spezialisiert
        'Wein': { basisPreis: 20, lager: 20, produktionsFaktor: 1.1 } // Importiert Wein (etwas teurer)
      }
    },

    // Region: Westliche Berge / Bergbau
    'Silberhafen': { x: 420, y: 95, einwohner: 900, versorgung: 'Mittel',
      gueter: {
        'Silbererz': { basisPreis: 40, lager: 30, produktionsFaktor: 0.8 }, // Hauptproduzent Silbererz
        'Eisen': { basisPreis: 30, lager: 20, produktionsFaktor: 0.9 },
        'Kohle': { basisPreis: 20, lager: 40, produktionsFaktor: 0.85 }
      }
    },
    'Ostwall': { x: 550, y: 130, einwohner: 1100, versorgung: 'Gut',
      gueter: {
        'Eisen': { basisPreis: 30, lager: 35, produktionsFaktor: 0.8 }, // Hauptproduzent Eisen
        'Waffen': { basisPreis: 70, lager: 10, produktionsFaktor: 0.95 },
        'Getreide': { basisPreis: 10, lager: 40, produktionsFaktor: 1.0 }
      }
    },

    // Region: Südliche Küste / Handwerk & Luxus
    'Drachenbucht': { x: 700, y: 180, einwohner: 1300, versorgung: 'Hervorragend',
      gueter: {
        'Wein': { basisPreis: 20, lager: 40, produktionsFaktor: 0.8 }, // Hauptproduzent Wein
        'Tuch': { basisPreis: 25, lager: 25, produktionsFaktor: 0.9 },
        'Seide': { basisPreis: 80, lager: 10, produktionsFaktor: 1.1 } // Importiert Seide
      }
    },
    'Sonnenküste': { x: 850, y: 250, einwohner: 1050, versorgung: 'Gut',
      gueter: {
        'Exotische Früchte': { basisPreis: 45, lager: 30, produktionsFaktor: 0.85 },
        'Juwelen': { basisPreis: 100, lager: 8, produktionsFaktor: 0.9 },
        'Gewürze': { basisPreis: 60, lager: 15, produktionsFaktor: 1.05 } // Handelsposten für Gewürze
      }
    },

    // Region: Östliche Küste / Fischerei & Alchemie
    'Tidenfall': { x: 880, y: 380, einwohner: 950, versorgung: 'Mittel',
      gueter: {
        'Fisch': { basisPreis: 12, lager: 70, produktionsFaktor: 0.8 }, // Hauptproduzent Fisch
        'Kräuter': { basisPreis: 22, lager: 50, produktionsFaktor: 0.9 },
        'Salz': { basisPreis: 18, lager: 30, produktionsFaktor: 0.85 } // Produziert Salz
      }
    },
    'Sturmkap': { x: 800, y: 500, einwohner: 1400, versorgung: 'Sehr Gut',
      gueter: {
        'Rüstungen': { basisPreis: 90, lager: 12, produktionsFaktor: 0.85 }, // Hauptproduzent Rüstungen
        'Waffen': { basisPreis: 70, lager: 10, produktionsFaktor: 1.0 },
        'Eisen': { basisPreis: 30, lager: 20, produktionsFaktor: 1.0 }
      }
    },

    // Region: Flussland / Landwirtschaft & Holz
    'Flussfurt': { x: 350, y: 350, einwohner: 700, versorgung: 'Mittel',
      gueter: {
        'Getreide': { basisPreis: 10, lager: 90, produktionsFaktor: 0.7 }, // Sehr guter Getreideproduzent
        'Holz': { basisPreis: 15, lager: 70, produktionsFaktor: 0.8 },
        'Leder': { basisPreis: 20, lager: 30, produktionsFaktor: 0.9 }
      }
    },
    'Auenbrück': { x: 550, y: 420, einwohner: 850, versorgung: 'Schlecht',
      gueter: {
        'Holz': { basisPreis: 15, lager: 60, produktionsFaktor: 0.75 }, // Sehr guter Holzproduzent
        'Kohle': { basisPreis: 20, lager: 50, produktionsFaktor: 0.8 },
        'Erz': { basisPreis: 30, lager: 25, produktionsFaktor: 0.9 }
      }
    },

    // Region: Inseln / Seltene Güter
    'Gezeitenruh': { x: 100, y: 500, einwohner: 600, versorgung: 'Sehr Schlecht',
      gueter: {
        'Rum': { basisPreis: 80, lager: 15, produktionsFaktor: 0.8 }, // Spezialisiert auf Rum
        'Tropische Hölzer': { basisPreis: 35, lager: 25, produktionsFaktor: 0.8 },
        'Gewürze': { basisPreis: 60, lager: 10, produktionsFaktor: 0.9 } // Kann Gewürze produzieren
      }
    },
    'Wolkenfels': { x: 920, y: 70, einwohner: 750, versorgung: 'Gut',
      gueter: {
        'Perlen': { basisPreis: 60, lager: 15, produktionsFaktor: 0.75 }, // Spezialisiert auf Perlen
        'Edelsteine': { basisPreis: 110, lager: 5, produktionsFaktor: 0.8 },
        'Seide': { basisPreis: 80, lager: 7, produktionsFaktor: 0.9 } // Kann Seide produzieren
      }
    }
  };

  // Liste aller existierenden Waren, um sicherzustellen, dass alle im Handelsmenü angezeigt werden
  // Dies sollte manuell gepflegt werden, wenn neue Waren hinzugefügt werden,
  // oder dynamisch aus allen STAEDTE-Gütern extrahiert werden.
  const ALLE_WAREN = [
    'Getreide', 'Fisch', 'Wolle', 'Holz', 'Tuch', 'Wein', 'Silbererz', 'Eisen', 'Kohle',
    'Waffen', 'Rüstungen', 'Exotische Früchte', 'Juwelen', 'Gewürze', 'Kräuter',
    'Salz', 'Leder', 'Seide', 'Rum', 'Tropische Hölzer', 'Perlen', 'Edelsteine'
  ];

  // --- SCHIFFS_TYPEN ---
  const SCHIFFS_TYPEN = [
    { name: 'Schnigge', levelNoetig: 1, kapazitaet: 50, preis: 500 },
    { name: 'Kraier', levelNoetig: 10, kapazitaet: 150, preis: 2000 },
    { name: 'Kogge', levelNoetig: 20, kapazitaet: 300, preis: 5000 },
    { name: 'Holk', levelNoetig: 30, kapazitaet: 600, preis: 10000 }
  ];

  // --- GEBÄUDE_TYPEN ---
  const GEBAEUDE_TYPEN = {
    'Lagerhaus': { kosten: 100, beschreibung: 'Erhöht Lagerplatz.' },
    'Kontor': { kosten: 200, beschreibung: 'Ermöglicht Landhandel.' }
  };

  // --- SPIELLOGIK FUNKTIONEN ---

  /**
   * Berechnet den aktuellen Verkaufspreis einer Ware in einer Stadt.
   * Der Preis schwankt leicht und wird durch den Produktionsfaktor der Stadt beeinflusst.
   * Zusätzlich wird ein dynamischer Preismodifikator basierend auf dem aktuellen Lagerbestand angewendet.
   * @param {string} stadtName - Name der Stadt.
   * @param {string} wareName - Name der Ware.
   * @returns {number} Aktueller Preis.
   */
  function berechneAktuellenPreis(stadtName, wareName) {
    const stadt = STAEDTE[stadtName];
    // Wenn die Stadt die Ware nicht in ihrer Liste hat, nehmen wir einen generischen Basispreis und Faktor 1.2 an.
    // So kann man sie trotzdem handeln, aber nicht als "Produzentenstadt".
    // Wichtig: Hier greifen wir auf die LIVE-Daten der Stadt zu, nicht auf die Konstante STAEDTE.
    if (!stadt.gueter[wareName]) {
        stadt.gueter[wareName] = { basisPreis: 30, lager: 0, produktionsFaktor: 1.2, basisLager: 0 }; // basisLager auch für unbekannte Waren initialisieren
    }
    const wareDaten = stadt.gueter[wareName];

    let preis = wareDaten.basisPreis * (wareDaten.produktionsFaktor || 1.0);

    // Dynamischer Preismodifikator basierend auf Lagerbestand
    // Je weniger auf Lager, desto höher der Preis (beim Kauf)
    // Je mehr auf Lager, desto niedriger der Preis (beim Verkauf)
    // Annahme für maximales Lager einer Ware in einer Stadt (könnte vom basisLager abhängen)
    const maxLager = wareDaten.basisLager > 0 ? wareDaten.basisLager * 2 : 100; // Wenn basisLager bekannt, nutze es, sonst 100
    const minLager = 0;

    let lagerProzentsatz = (wareDaten.lager - minLager) / (maxLager - minLager);
    lagerProzentsatz = Math.max(0, Math.min(1, lagerProzentsatz)); // Sicherstellen, dass es zwischen 0 und 1 liegt

    // Preismodifikator: Niedriger Lagerbestand -> hoher Modifikator (Preis steigt)
    // Hoher Lagerbestand -> niedriger Modifikator (Preis sinkt)
    // Beispiel: Bei 0% Lager -> Modifikator 1.5; Bei 100% Lager -> Modifikator 0.5
    const preisModifikator = 1.5 - (lagerProzentsatz * 1.0); // Passt von 1.5 (leer) zu 0.5 (voll)

    preis *= preisModifikator;

    // Einfache Zufallsschwankung (+/- 5% des Basispreises)
    const schwankung = Math.floor(Math.random() * (wareDaten.basisPreis * 0.1)) - (wareDaten.basisPreis * 0.05);
    preis += schwankung;

    // Ruf-Einfluss auf den Preis
    // Guter Ruf: Kaufpreis sinkt, Verkaufspreis steigt (Spieler bekommt mehr)
    // Schlechter Ruf: Kaufpreis steigt, Verkaufspreis sinkt (Spieler bekommt weniger)
    // Beispiel: Bei Ruf +5: Preis * (1 - 0.05) = Preis * 0.95 (5% Rabatt beim Kauf, 5% Bonus beim Verkauf)
    // Bei Ruf -5: Preis * (1 + 0.05) = Preis * 1.05 (5% Aufschlag beim Kauf, 5% Abzug beim Verkauf)
    const rufEinflussFaktor = SPIELER_DATEN.ruf * 0.01; // Z.B. +/- 1% pro Rufpunkt

    // Für Kaufpreis:
    if (SPIELER_DATEN.ruf > 0) { // Guter Ruf: Preis sinkt
        preis *= (1 - rufEinflussFaktor);
    } else if (SPIELER_DATEN.ruf < 0) { // Schlechter Ruf: Preis steigt
        preis *= (1 - rufEinflussFaktor); // negative rufEinflussFaktor wird zu positivem Zuschlag
    }
    // Bei Ruf 0 bleibt es neutral

    return Math.max(1, Math.round(preis)); // Preis muss mindestens 1 sein und ganzzahlig
  }

  /**
   * Gibt die gesamte verfügbare Ladekapazität des Spielers zurück (summiert über alle Schiffe).
   * @returns {number} Freie Ladekapazität.
   */
  function getGesamtLadekapazitaet() {
    let gesamtKapazitaet = 0;
    SPIELER_DATEN.schiffeBesitz.forEach(schiff => {
      gesamtKapazitaet += schiff.kapazitaet;
    });
    return gesamtKapazitaet;
  }

  /**
   * Gibt die aktuell genutzte Ladekapazität des Spielers zurück.
   * @returns {number} Genutzte Ladekapazität.
   */
  function getAktuelleLadungsmenge() {
    let aktuelleLadung = 0;
    for (const wareName in SPIELER_DATEN.inventar) {
      aktuelleLadung += SPIELER_DATEN.inventar[wareName];
    }
    return aktuelleLadung;
  }

  /**
   * Wählt eine Stadt aus und aktualisiert die Ansicht.
   * @param {string} name - Der Name der ausgewählten Stadt.
   */
  function stadtWaehlen(name) {
    SPIELER_DATEN.aktuelleStadt = name;
    markiereAktuelleStadt(name);
    zeigeMenue('uebersicht');
  }

  /**
   * Zeigt das gewählte Menü (Übersicht, Handel, Gebäude, Schiffe) an.
   * @param {string} menuepunkt - Der Name des Menüpunkts.
   */
  function zeigeMenue(menuepunkt) {
    const inhaltDiv = document.getElementById('inhalt');

    aktualisiereSpielerStatusAnzeige(); // Immer den Spielerstatus aktualisieren

    if (!SPIELER_DATEN.aktuelleStadt && menuepunkt !== 'schiffe') {
      inhaltDiv.innerHTML = '<p>Bitte zuerst eine Stadt auf der Karte auswählen!</p>';
      return;
    }

    let htmlInhalt = '';
    const aktuelleStadtDaten = SPIELER_DATER.aktuelleStadt ? STAEDTE[SPIELER_DATEN.aktuelleStadt] : null;

    switch (menuepunkt) {
      case 'uebersicht':
        htmlInhalt = `<h2>${SPIELER_DATEN.aktuelleStadt} – Übersicht</h2>
          <p>Einwohner: ${aktuelleStadtDaten.einwohner}</p>
          <p>Versorgung: ${aktuelleStadtDaten.versorgung}</p>`;
        break;

      case 'handel':
        htmlInhalt = `<h2>${SPIELER_DATEN.aktuelleStadt} – Handel</h2>
          <table>
            <tr><th>Ware</th><th>Preis</th><th>Stadt-Lager</th><th>Deine Menge</th><th colspan="2">Aktion</th></tr>`;

        // Iteriere über ALLE_WAREN, um sicherzustellen, dass jede Ware angezeigt wird
        ALLE_WAREN.forEach(wareName => {
          // Prüfen, ob die Stadt diese spezifische Ware in ihren Gütern hat,
          // andernfalls Standardwerte oder 0 verwenden.
          // Wichtig: Hier greifen wir auf die LIVE-Daten der Stadt zu, nicht auf die Konstante STAEDTE.
          if (!aktuelleStadtDaten.gueter[wareName]) {
              aktuelleStadtDaten.gueter[wareName] = { basisPreis: 30, lager: 0, produktionsFaktor: 1.2, basisLager: 0 };
          }
          const wareInStadt = aktuelleStadtDaten.gueter[wareName];
          const preis = berechneAktuellenPreis(SPIELER_DATEN.aktuelleStadt, wareName);
          const spielerMenge = SPIELER_DATEN.inventar[wareName] || 0;
          const stadtLager = wareInStadt.lager;

          const kannKaufen = (stadtLager > 0);
          const kannVerkaufen = (spielerMenge > 0);

          htmlInhalt += `
              <tr>
                <td>${wareName}</td>
                <td id="preis_${wareName}">${preis} Gold</td>
                <td id="stadtLager_${wareName}">${stadtLager}</td>
                <td id="spielerMenge_${wareName}">${spielerMenge}</td>
                <td>
                  <input type="number" id="mengeKaufen_${wareName}" value="1" min="1" max="${stadtLager}" style="width: 60px;" ${kannKaufen ? '' : 'disabled'}>
                  <button id="btnKaufen_${wareName}" onclick="handelWare('${wareName}', 'kaufen')" ${kannKaufen ? '' : 'disabled'}>Kaufen</button>
                </td>
                <td>
                  <input type="number" id="mengeVerkaufen_${wareName}" value="1" min="1" max="${spielerMenge}" style="width: 60px;" ${kannVerkaufen ? '' : 'disabled'}>
                  <button id="btnVerkaufen_${wareName}" onclick="handelWare('${wareName}', 'verkaufen')" ${kannVerkaufen ? '' : 'disabled'}>Verkaufen</button>
                </td>
              </tr>`;
        });
        htmlInhalt += `</table>
        <h3>Dein Inventar:</h3>
        <table>
          <tr><th>Ware</th><th>Menge</th></tr>`;
          let inventarLeer = true;
          for (const wareName in SPIELER_DATEN.inventar) {
            if (SPIELER_DATEN.inventar[wareName] > 0) {
              htmlInhalt += `<tr><td>${wareName}</td><td>${SPIELER_DATEN.inventar[wareName]}</td></tr>`;
              inventarLeer = false;
            }
          }
          if (inventarLeer) {
            htmlInhalt += `<tr><td colspan="2">Dein Inventar ist leer.</td></tr>`;
          }
          htmlInhalt += `</table>`;
        break;

      case 'gebaeude':
        htmlInhalt = `<h2>${SPIELER_DATEN.aktuelleStadt} – Gebäude</h2>
          <h3>Besitz in ${SPIELER_DATEN.aktuelleStadt}:</h3>
          <ul>`;
          const stadtGebaeude = SPIELER_DATEN.gebaeude[SPIELER_DATEN.aktuelleStadt] || {};
          if (Object.keys(stadtGebaeude).length === 0) {
            htmlInhalt += `<li>Keine Gebäude im Besitz.</li>`;
          } else {
            for (const gebaeudeName in stadtGebaeude) {
              htmlInhalt += `<li>${gebaeudeName} (Stufe ${stadtGebaeude[gebaeudeName]})</li>`;
            }
          }
          htmlInhalt += `</ul>
          <h3>Verfügbare Gebäude zum Bau:</h3>
          <ul>`;
          for (const gebaeudeName in GEBAEUDE_TYPEN) {
            const gebaeudeTyp = GEBAEUDE_TYPEN[gebaeudeName];
            htmlInhalt += `<li>${gebaeudeName} (${gebaeudeTyp.beschreibung}) – Kosten: ${gebaeudeTyp.kosten} Gold <button onclick="gebaeudeBauen('${gebaeudeName}', ${gebaeudeTyp.kosten})">Bauen</button></li>`;
          }
          htmlInhalt += `</ul>`;
        break;

      case 'schiffe':
        htmlInhalt = `<h2>Werft – Schiffe</h2>
          <h3>Verfügbare Schiffstypen zum Kauf:</h3>
          <div class="schiff-container">`;
        SCHIFFS_TYPEN.forEach(schiff => {
          const kannKaufen = SPIELER_DATEN.level >= schiff.levelNoetig && SPIELER_DATEN.gold >= schiff.preis;
          htmlInhalt += `
            <div class="schiff-karte">
              <h3>${schiff.name}</h3>
              <div class="schiff-info">
                <p>Benötigtes Level: ${schiff.levelNoetig}</p>
                <p>Kapazität: ${schiff.kapazitaet} Einheiten</p>
                <p>Preis: ${schiff.preis} Gold</p>
              </div>
              <div class="schiff-aktionen">
                <button class="kaufen-button" onclick="schiffKaufen('${schiff.name}', ${schiff.preis})" ${kannKaufen ? '' : 'disabled'}>
                  ${kannKaufen ? 'Kaufen' : 'Nicht verfügbar'}
                </button>
              </div>
            </div>`;
        });
        htmlInhalt += `</div>
          <h3>Deine Schiffe:</h3>
          <ul>`;
        if (SPIELER_DATEN.schiffeBesitz.length === 0) {
          htmlInhalt += `<li>Du besitzt noch keine Schiffe.</li>`;
        } else {
          SPIELER_DATEN.schiffeBesitz.forEach((schiff, index) => {
            htmlInhalt += `<li>${schiff.name} (Kapazität: ${schiff.kapazitaet}, Beladen: ${schiff.ladungsmenge || 0})`;
            // Optional: Hier könnte man weitere Aktionen pro Schiff einfügen (z.b. beladen, entladen, reparieren)
            htmlInhalt += `</li>`;
          });
        }
        htmlInhalt += `</ul>`;
        break;

      default:
        htmlInhalt = `<p>Ein unbekanntes Menü wurde aufgerufen.</p>`;
    }
    inhaltDiv.innerHTML = htmlInhalt;
  }

  /**
   * Führt einen Kauf oder Verkauf einer Ware aus.
   * Aktualisiert Stadtlager, Spielerinventar, Gold, XP und Ruf.
   * @param {string} wareName - Der Name der Ware.
   * @param {'kaufen'|'verkaufen'} aktion - Die Aktion (kaufen oder verkaufen).
   */
  function handelWare(wareName, aktion) {
    const aktuelleStadtDaten = STAEDTE[SPIELER_DATEN.aktuelleStadt];
    // Stellen Sie sicher, dass die Ware in den gueter der Stadt existiert,
    // ansonsten initialisieren wir sie mit einem Lager von 0.
    if (!aktuelleStadtDaten.gueter[wareName]) {
        aktuelleStadtDaten.gueter[wareName] = { basisPreis: 30, lager: 0, produktionsFaktor: 1.2, basisLager: 0 };
    }
    const wareInStadt = aktuelleStadtDaten.gueter[wareName];

    let mengeInputId = (aktion === 'kaufen') ? `mengeKaufen_${wareName}` : `mengeVerkaufen_${wareName}`;
    let mengeElement = document.getElementById(mengeInputId);
    let menge = parseInt(mengeElement.value);

    if (isNaN(menge) || menge <= 0) {
      alert('Bitte gib eine gültige Menge ein (mindestens 1).');
      return;
    }

    const preisProEinheit = berechneAktuellenPreis(SPIELER_DATEN.aktuelleStadt, wareName);
    const gesamtPreis = preisProEinheit * menge;

    let rufAenderung = 0; // Rufänderung durch diese Transaktion

    if (aktion === 'kaufen') {
      if (SPIELER_DATEN.gold < gesamtPreis) {
        alert('Nicht genug Gold!');
        return;
      }
      if (wareInStadt.lager < menge) {
        alert('Stadt hat nicht genug Waren auf Lager!');
        return;
      }
      if (getAktuelleLadungsmenge() + menge > getGesamtLadekapazitaet()) {
          alert(`Nicht genug Ladekapazität! Du hast ${getAktuelleLadungsmenge()} / ${getGesamtLadekapazitaet()} belegt.`);
          return;
      }

      SPIELER_DATEN.gold -= gesamtPreis;
      wareInStadt.lager -= menge; // Lager der Stadt verringert sich
      SPIELER_DATEN.inventar[wareName] = (SPIELER_DATEN.inventar[wareName] || 0) + menge;
      aktualisiereXP(5 * menge); // Mehr XP für größere Mengen
      alert(`${menge} ${wareName} für ${gesamtPreis} Gold gekauft.`);

      // Rufanpassung beim Kauf:
      // Kauf von knappen Gütern (Lager niedrig) könnte den Ruf leicht senken,
      // da man der Stadt etwas wegnimmt, das sie vielleicht braucht.
      // Der basisLager Wert wird zum Vergleich herangezogen.
      if (wareInStadt.lager < wareInStadt.basisLager * 0.5) { // Wenn Lager unter 50% des Basiswerts
          rufAenderung -= Math.floor(menge / 10); // Pro 10 Einheiten 1 Rufpunkt Abzug
      }


    } else if (aktion === 'verkaufen') {
      if (!SPIELER_DATEN.inventar[wareName] || SPIELER_DATEN.inventar[wareName] < menge) {
        alert('Du hast nicht genug dieser Ware in deinem Inventar!');
        return;
      }

      SPIELER_DATEN.gold += gesamtPreis;
      wareInStadt.lager += menge; // Lager der Stadt erhöht sich
      SPIELER_DATEN.inventar[wareName] -= menge;
      aktualisiereXP(5 * menge);
      alert(`${menge} ${wareName} für ${gesamtPreis} Gold verkauft.`);

      // Rufanpassung beim Verkauf:
      // Verkauf von dringend benötigten Gütern (Lager niedrig) könnte den Ruf erhöhen.
      // Verkauf von überflüssigen Gütern (Lager hoch) ist neutral oder leicht negativ (Marktüberschwemmung).
      if (wareInStadt.lager < wareInStadt.basisLager * 0.5) { // Wenn Lager unter 50% des Basiswerts
          rufAenderung += Math.floor(menge / 10); // Pro 10 Einheiten 1 Rufpunkt Zuwachs
      } else if (wareInStadt.lager > wareInStadt.basisLager * 1.5) { // Wenn Lager über 150% des Basiswerts
          rufAenderung -= Math.floor(menge / 20); // Bei Überschuss leichter Abzug
      }
    }

    // Ruf aktualisieren und im Bereich -5 bis +5 halten
    SPIELER_DATEN.ruf = Math.max(-5, Math.min(5, SPIELER_DATEN.ruf + rufAenderung));


    // Aktualisiere die Anzeigen direkt
    document.getElementById(`stadtLager_${wareName}`).textContent = wareInStadt.lager;
    document.getElementById(`spielerMenge_${wareName}`).textContent = SPIELER_DATEN.inventar[wareName];

    // Aktualisiere die max-Werte und den disabled-Status der Buttons
    const neuerStadtLager = wareInStadt.lager;
    const neuerSpielerMenge = SPIELER_DATEN.inventar[wareName] || 0;

    // Kauf-Button aktualisieren
    const kaufenInput = document.getElementById(`mengeKaufen_${wareName}`);
    const kaufenButton = document.getElementById(`btnKaufen_${wareName}`);
    if (kaufenInput && kaufenButton) {
        kaufenInput.setAttribute('max', neuerStadtLager);
        if (neuerStadtLager <= 0) {
            kaufenInput.disabled = true;
            kaufenButton.disabled = true;
        } else {
            kaufenInput.disabled = false;
            kaufenButton.disabled = false;
        }
        kaufenInput.value = 1; // Setze Menge zurück auf 1 nach Handel
    }


    // Verkauf-Button aktualisieren
    const verkaufenInput = document.getElementById(`mengeVerkaufen_${wareName}`);
    const verkaufenButton = document.getElementById(`btnVerkaufen_${wareName}`);
    if (verkaufenInput && verkaufenButton) {
        verkaufenInput.setAttribute('max', neuerSpielerMenge);
        if (neuerSpielerMenge <= 0) {
            verkaufenInput.disabled = true;
            verkaufenButton.disabled = true;
        } else {
            verkaufenInput.disabled = false;
            verkaufenButton.disabled = false;
        }
        verkaufenInput.value = 1; // Setze Menge zurück auf 1 nach Handel
    }

    document.getElementById(`preis_${wareName}`).textContent = `${berechneAktuellenPreis(SPIELER_DATEN.aktuelleStadt, wareName)} Gold`;

    aktualisiereSpielerStatusAnzeige(); // Gold/XP/Ladekapazität aktualisieren
  }

  /**
   * Baut ein Gebäude in der aktuellen Stadt.
   * @param {string} gebaeudeName - Der Name des zu bauenden Gebäudes.
   * @param {number} kosten - Die Kosten des Gebäudes.
   */
  function gebaeudeBauen(gebaeudeName, kosten) {
    if (SPIELER_DATEN.gold >= kosten) {
      if (!SPIELER_DATEN.gebaeude[SPIELER_DATEN.aktuelleStadt]) {
        SPIELER_DATEN.gebaeude[SPIELER_DATEN.aktuelleStadt] = {};
      }
      // Einfache Logik: Nur Stufe 1 Gebäude
      if (!SPIELER_DATEN.gebaeude[SPIELER_DATEN.aktuelleStadt][gebaeudeName]) {
        SPIELER_DATEN.gold -= kosten;
        SPIELER_DATEN.gebaeude[SPIELER_DATEN.aktuelleStadt][gebaeudeName] = 1; // Stufe 1
        aktualisiereXP(20);
        alert(`${gebaeudeName} in ${SPIELER_DATEN.aktuelleStadt} gebaut!`);
      } else {
        alert(`Du hast bereits ein ${gebaeudeName} in ${SPIELER_DATEN.aktuelleStadt}.`);
      }
    } else {
      alert('Nicht genug Gold, um dieses Gebäude zu bauen!');
    }
    zeigeMenue('gebaeude');
  }

  /**
   * Kauft ein Schiff für den Spieler.
   * @param {string} schiffName - Der Name des zu kaufenden Schiffstyps.
   * @param {number} preis - Der Preis des Schiffes.
   */
  function schiffKaufen(schiffName, preis) {
    const schiffTyp = SCHIFFS_TYPEN.find(s => s.name === schiffName);
    if (!schiffTyp) {
      alert('Unbekannter Schiffstyp!');
      return;
    }

    if (SPIELER_DATEN.gold >= preis && SPIELER_DATEN.level >= schiffTyp.levelNoetig) {
      SPIELER_DATEN.gold -= preis;
      SPIELER_DATEN.schiffeBesitz.push({
        name: schiffTyp.name,
        kapazitaet: schiffTyp.kapazitaet,
        ladungsmenge: 0, // Aktuell beladene Menge
        ladungsDetails: {} // Speichert z.B. {'Holz': 10, 'Getreide': 5}
      });
      aktualisiereXP(50);
      alert(`${schiffName} gekauft!`);
    } else if (SPIELER_DATEN.level < schiffTyp.levelNoetig) {
      alert(`Dein Level ist zu niedrig. Du benötigst Level ${schiffTyp.levelNoetig}, um ${schiffName} zu kaufen.`);
    } else {
      alert('Nicht genug Gold, um dieses Schiff zu kaufen!');
    }
    zeigeMenue('schiffe'); // Menü neu laden, um den Kauf zu reflektieren und Buttons zu aktualisieren
  }

  /**
   * Fügt dem Spieler XP hinzu und prüft auf Levelaufstieg.
   * @param {number} menge - Die Menge an XP, die hinzugefügt werden soll.
   */
  function aktualisiereXP(menge) {
    SPIELER_DATEN.xp += menge;
    const xpFuerNaechstesLevel = SPIELER_DATEN.level * 100; // Beispiel: 100 XP für Level 2, 200 für Level 3, etc.
    if (SPIELER_DATEN.xp >= xpFuerNaechstesLevel) {
      SPIELER_DATEN.level++;
      SPIELER_DATEN.xp -= xpFuerNaechstesLevel; // Verbleibende XP nach Levelaufstieg
      alert(`Herzlichen Glückwunsch! Du bist Level ${SPIELER_DATEN.level} aufgestiegen!`);
    }
    aktualisiereSpielerStatusAnzeige();
  }

  /**
   * Gibt den Ruf-Rang-Namen basierend auf dem Rufwert zurück.
   * @param {number} rufValue - Der aktuelle Rufwert des Spielers.
   * @returns {string} Der Name des Ruf-Rangs.
   */
  function getRufRangName(rufValue) {
      // Sicherstellen, dass der Rufwert im gültigen Bereich liegt
      const clampedRuf = Math.max(-5, Math.min(5, rufValue));
      return RUF_RANG_DEFINITIONEN[clampedRuf.toString()].name;
  }

  /**
   * Aktualisiert die Anzeige des Spielerstatus im HTML.
   */
  function aktualisiereSpielerStatusAnzeige() {
    document.getElementById('goldAnzeige').textContent = SPIELER_DATEN.gold;
    document.getElementById('levelAnzeige').textContent = SPIELER_DATEN.level;
    document.getElementById('xpAnzeige').textContent = SPIELER_DATEN.xp;
    document.getElementById('rufAnzeige').textContent = SPIELER_DATEN.ruf;
    document.getElementById('rufRangAnzeige').textContent = getRufRangName(SPIELER_DATEN.ruf);
    document.getElementById('aktuelleStadtAnzeige').textContent = SPIELER_DATEN.aktuelleStadt || 'Keine';
    document.getElementById('ladekapazitaetAnzeige').textContent = `${getAktuelleLadungsmenge()} / ${getGesamtLadekapazitaet()}`;
  }

  // --- VISUELLE HILFSFUNKTIONEN ---

  let currentMarkedCity = null; // Speichert den aktuell markierten Stadtkreis

  /**
   * Markiert die ausgewählte Stadt auf der Karte visuell.
   * @param {string} stadtName - Der Name der Stadt, die markiert werden soll.
   */
  function markiereAktuelleStadt(stadtName) {
    // Entferne die Markierung von der vorherigen Stadt
    if (currentMarkedCity) {
        currentMarkedCity.setAttribute('fill', '#3366cc'); // Setze Standardfarbe zurück
        currentMarkedCity.setAttribute('r', '8'); // Setze Standardgröße zurück
    }

    // Finde den Kreis der neuen Stadt über das data-Attribut
    const neueStadtCircle = document.querySelector(`.stadt-button[data-stadt-name="${stadtName}"]`);
    if (neueStadtCircle) {
        neueStadtCircle.setAttribute('fill', '#ff0000'); // Neue Farbe (Rot) für ausgewählte Stadt
        neueStadtCircle.setAttribute('r', '12'); // Größerer Kreis
        currentMarkedCity = neueStadtCircle; // Speichere die aktuelle Stadt als markiert
    }
  }

  // --- INITIALISIERUNG DES SPIELS ---

  /**
   * Initialisiert das Spiel beim Laden der Seite.
   * Erstellt die Städte auf der Karte dynamisch und setzt die Startansicht.
   */
  document.addEventListener('DOMContentLoaded', () => {
    const karteSVG = document.getElementById('karte');

    // Dynamische Kartenerstellung (Städte)
    for (const stadtName in STAEDTE) {
      const stadtDaten = STAEDTE[stadtName];

      // Initialisiere basisLager für jede Ware in jeder Stadt (für Ruf- und Preisberechnung)
      for (const wareName in stadtDaten.gueter) {
          // Sicherstellen, dass basisLager gesetzt ist; falls nicht, ist es der initiale Lagerwert
          if (typeof stadtDaten.gueter[wareName].basisLager === 'undefined') {
            stadtDaten.gueter[wareName].basisLager = stadtDaten.gueter[wareName].lager;
          }
      }

      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('class', 'stadt-button');
      circle.setAttribute('cx', stadtDaten.x);
      circle.setAttribute('cy', stadtDaten.y);
      circle.setAttribute('r', '8');
      circle.dataset.stadtName = stadtName; // Speichert den Stadtnamen im data-Attribut
      karteSVG.appendChild(circle);

      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', stadtDaten.x + 10);
      text.setAttribute('y', stadtDaten.y + 5);
      text.textContent = stadtName;
      text.style.pointerEvents = 'none'; // Verhindert, dass der Text Klicks abfängt
      karteSVG.appendChild(text);
    }

    // Event Listener für die Städte-Buttons (Kreise)
    document.querySelectorAll('.stadt-button').forEach(button => {
      button.addEventListener('click', (event) => {
        stadtWaehlen(event.target.dataset.stadtName);
      });
    });

    // Gib dem Spieler ein Startschiff, damit er Kapazität hat
    if (SPIELER_DATEN.schiffeBesitz.length === 0) { // Nur hinzufügen, wenn noch keine Schiffe vorhanden sind
        SPIELER_DATEN.schiffeBesitz.push({
            name: 'Schnigge',
            kapazitaet: SCHIFFS_TYPEN.find(s => s.name === 'Schnigge').kapazitaet,
            ladungsmenge: 0,
            ladungsDetails: {}
        });
    }

    // Setze die initiale Ansicht und den Spielerstatus
    aktualisiereSpielerStatusAnzeige();
    document.getElementById('inhalt').innerHTML = '<p>Wähle eine Stadt auf der Karte, um zu beginnen.</p>';
  });
</script>

</body>
</html>
